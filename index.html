<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="google" content="notranslate" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
	<meta name="title" content="Green Runchly">
	<meta name="author" content="Green Runchly">
	<link rel="icon" href="assets/me.png">

	<title>Green Runchly</title>

	<meta property="og:site_name" content="Green Runchly">
    <meta property="og:title" content="Green Runchly" />
    <meta property="og:description" content="Rizki's Personal Website" />
    <meta property="og:image" itemprop="image" content="assets/me.png">
    <meta property="og:type" content="website" />

	<!-- Bootstrap Style -->
    <link href="assets/css/bootstrap-5.3.2-dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="assets/css/bootstrap-5.3.2-dist/js/bootstrap.bundle.min.js"></script>
	<link rel="stylesheet" href="assets/css/bootstrap-icons-1.11.3/font/bootstrap-icons.min.css">
	
	<!-- JQuery -->
	<script src="assets/js/jquery-3.5.1.min.js"></script>
    <script src="assets/js/jquery.countdown.js"></script>

	<!-- DB Framework -->
	<script src="assets/js/localforage/dist/localforage.js"></script>
</head>
<style>
	body{
		margin: 0px;
		padding: 0px;
		background: #00b081;
		background-attachment: fixed;
	}
	.main{
		display: flex;
		align-items: center;
		justify-content: center;
		width: 100%;
		height: 100vh;
	}
	.logo{
		display: flex;
		align-items: center;
		justify-content: center;
		width: 300px;
		height: 300px;
		border-radius: 50%;
		border:1rem solid white;
		transform: scale(1);
		-webkit-tap-highlight-color: transparent;
		cursor: pointer;
		z-index: 989;
	}
	.logo.bass-overlay{
		position: absolute;
		opacity: 0.1;
		z-index: 990;
	}
	.logo img{
		width: 100%;
		height: 100%;
		object-fit: cover;
		border-radius: 50%;
		overflow: hidden;
		cursor: pointer;
	}
	.visibilitas{
		opacity: 1;
		transition: 0.5s;
	}
	.visibilitas.hide{
		opacity: 0;
	}
	.visibilitas.hide:hover{
		opacity: 1;
	}
	.music-progress-bar{
		height: 7px;
	}
	.music-progress-bar .filler{
		width: calc(var(--progress));
		min-width: 16px;
		transition: 0.5s;
	}
	.spectrume{
		position: absolute;
		display: flex;
		align-items: flex-end;
		list-style-type: none;
		margin: 0rem;
		padding: 0rem;
		/* z-index: 9999; */
	}
	.spectrume li{
		position: absolute;
		width: 7px;
		background-color: white;
		transform-origin: 0% 100% 0;
		border-radius: 3px;
	}
</style>
<body class="overflow-hidden">	
	<div class="d-block position-relative overflow-hidden">
		<div class="main" id="flash">
			<ul style="transform: rotate(45deg);" class="spectrume" id="spectrumeBeat"></ul>
			<!-- <ul style="transform: rotate(90deg);" class="spectrume" id="spectrumeBeatOverlay"></ul> -->
			<a class="logo" id="spectrumeBass">
				<img src="assets/me.png" draggable="false">
			</a>
			<a class="logo paused mediaPlayerStarter bass-overlay" id="spectrumeBassOverlay">
				<img src="assets/me.png" draggable="false">
			</a>
		</div>
	</div>
	<div class="container-fluid py-2 px-2 fixed-top">
		<div class="row">
			<div class="col-12 col-sm-6 col-lg-3 visibilitas hide" id="mediaList">
				<div class="row g-1 lh-sm">
					<div class="col-12">
						<a class="btn text-white text-end">
							<p class="m-0" id="mediaPlayerMusicImporterStatus">Perpustakaan Lagu</p>
						</a>
					</div>
				</div>
				<div class="row g-1 lh-sm overflow-hidden overflow-y-scroll my-1 rounded-3" style="max-height: 40vh;">
					
				</div>
				<div class="row">
					<div class="col-12">
						<div class="row g-1">
							<div class="col-auto">
								<button class="btn btn-danger removeAllMusic"><i class="bi bi-recycle"></i></button>
							</div>
							<div class="col">
								<label for="mediaPlayerMusicImporter" class="btn btn-success w-100 text-start importMusic">
									<small class="m-0">Klik untuk import lagu...</small>
								</label>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>
	<div class="container-fluid py-2 px-2 fixed-bottom visibilitas" id="mediaPlayer">
		<div class="row g-2 py-2" id="mediaPlayerControl">
			<div class="col-auto">
				<button class="btn btn-success mediaPlayerStarter" id="mediaPlayerStarter"><i class="bi bi-play-fill"></i></button>
			</div>
			<div class="col-auto">
				<audio class="d-none" id="mediaPlayerAudio" controls loop>
					<source src="assets/audio/the drum.webm" type="audio/mpeg">
				</audio>
				<input class="form-control d-none" id="mediaPlayerSelector" type="file" accept="audio/*" />
				<label for="mediaPlayerSelector" class="btn btn-success"><i class="bi bi-upload"></i></label>
			</div>
			<div class="col-auto d-none d-sm-block">
				<input class="form-control d-none" type="file" id="mediaPlayerMusicImporter" accept="audio/*" webkitdirectory directory multiple />
				<button class="btn btn-success" id="mediaListToggle"><i class="bi bi-music-note-list"></i></button>
			</div>
			<div class="col-auto d-none d-sm-block">
				<div class="btn text-white text-end">
					<p class="m-0"><span id="mediaPlayerAudioProgressTextCurrent">0.00</span>%</p>
				</div>
			</div>
			<div class="col-auto d-none">
				<div class="btn text-white">
					<p class="m-0">Gi <span id="gitarEnergy"></span>&nbsp;Ba <span id="bassEnergy"></span>&nbsp;Sn <span id="snareEnergy"></span>&nbsp;Si <span id="simbalEnergy"></span>&nbsp;Tr <span id="trebleEnergy"></span></p>
				</div>
			</div>
			<div class="col d-flex justify-content-end justify-content-lg-end align-items-end">
				<a class="btn text-white text-end" href="https://ieu.link/tentang" target="_blank">
					<p class="m-0">&copy2024 GreenRunchly</p>
				</a>
			</div>
			<div class="col-auto d-none d-sm-block">
				<button class="btn btn-success" id="mediaPlayerToggle"><i class="bi bi-eye-slash-fill"></i></button>
			</div>
		</div>
		<div class="row">
			<div class="col-12">
				<div class="music-progress-bar bg-body w-100 rounded-3">
					<div class="filler bg-success h-100 rounded-3" id="mediaPlayerAudioProgress" style="--progress:100%;"></div>
				</div>
			</div>
		</div>
	</div>
</body>
<script src="assets/js/p5.js"></script>
<script src="assets/js/p5.sound.js"></script>
<script>
	let importedSongs = localforage.createInstance({
        name: "Songs"
    });

	// Mengonversi file ke Base64
    function fileToBase64(file) {
		return new Promise((resolve, reject) => {
			const reader = new FileReader();
			reader.readAsDataURL(file);
			reader.onload = () => resolve(reader.result);
			reader.onerror = error => reject(error);
		});
    }

	loadMusicLists();

	// Import Listing Baru
    $('#mediaPlayerMusicImporter').on('change', function(event) {
        const files = event.target.files; 
		let importedFile = {}; let importedCount = 0; let importingCount = 0;
		
		$.each(files, function(index, file) {
			const fileExtension = file.name.split('.').pop().toLowerCase();
			if ((['mp3', 'wav', 'ogg', 'flac', 'webm'].includes(fileExtension)) && (file.size > (2 * 1024 * 1024))){
				new Promise((resolve, reject) => {
					let folderPath = file.webkitRelativePath.split('/').slice(0, -1);
					let lagu = fileToBase64(file);
					$('.importMusic').html(`<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> <small class="m-0">Mengimpor Lagu... (${importedCount}/${importingCount}) ${folderPath[1]} </small>`);
					importedSongs.setItem(folderPath[1], lagu, function (err) {} ).then(function () {
						$('.importMusic').html(`<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> <small class="m-0">Menyimpan Lagu... (${importedCount}/${importingCount}) ${folderPath[1]} </small>`);
						resolve();
					}).catch(function (err) {
						console.log(err);
						reject(err);
					});
				}).then(() => {
					importedCount ++;
				}).catch((error) => {
					console.error(error);
				});
				importingCount ++;
			}
		});

		let waitImporting = setInterval(() => {
			if (importingCount == importedCount){
				console.log('Done!', importingCount, importedCount);
				loadMusicLists();
				clearInterval(waitImporting);
			}
		}, 1000);
    });

	// Load Listing
	function loadMusicLists() {
		$('#mediaList').children('div').eq(1).html();
		$('.importMusic').html('<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> <small class="m-0">Memuat Lagu...</small>');
		let html = ``;

		importedSongs.keys().then(function(keys) {
			keys.forEach(function(key, iterationNumber) {
				html += `
				<div class="col-12">
					<div class="row g-1">
						<div class="col-auto">
							<button class="btn btn-danger removeMusic" music-number="${key}"><i class="bi bi-trash-fill"></i></button>
						</div>
						<div class="col">
							<button class="btn btn-success w-100 text-start selectMusic" music-number="${key}">
								<small><small class="m-0">${key}</small></small>
							</button>
						</div>
					</div>
				</div>
				`;
			});
			$('#mediaList').children('div').eq(1).html(html);
			$("#mediaPlayerMusicImporterStatus").html('Perpustakaan Lagu');
			console.log('Selesai!');
			$('.importMusic').html('<small class="m-0">Klik untuk import lagu...</small>');
		}).catch(function(err) {
			console.error("Error during iteration", err);
		});
	}

	// Play Selected Music
	$(document).on("click", ".selectMusic", function(e) {
		let musicID = $(this).attr('music-number');

		importedSongs.getItem(musicID).then(function (lagu) {
			$("#mediaPlayerAudio").attr("src", lagu);
			$("#mediaPlayerAudio")[0].play();
		}).catch(function (err) {
			console.log(err);
		});
	});

	// Hapus Music
	$(document).on("click", ".removeMusic", function(e) {
		let musicID = $(this).attr('music-number');
		$(this).html('<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>');
		importedSongs.removeItem(musicID).then(function() {
			loadMusicLists();
		}).catch(function(err) {
			alert("Gagal Menghapus!");
		});
	});

	// Hapus Semua Music
	$(document).on("click", ".removeAllMusic", function(e) {
		let me = this;
		$(this).html('<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>');
		importedSongs.clear().then(function() {
			$(me).html('<i class="bi bi-recycle"></i>');
			loadMusicLists();
		}).catch(function(err) {
			alert("Gagal Menghapus Library!");
		});
	});

</script>
<script>
	$(document).on("click", "#mediaPlayerToggle", function(e) {
		isit = $("#mediaPlayer").hasClass('hide');
        if (isit == true){
            $("#mediaPlayer").removeClass('hide');
			$("#mediaPlayerToggle").html('<i class="bi bi-eye-slash-fill"></i>');
        }else{
            $("#mediaPlayer").addClass('hide');
			$("#mediaPlayerToggle").html('<i class="bi bi-eye-fill"></i>');
        }
    });
	$(document).on("click", "#mediaListToggle", function(e) {
		isit = $("#mediaList").hasClass('hide');
        if (isit == true){
            $("#mediaList").removeClass('hide');
			$("#mediaListToggle").html('<i class="bi bi-music-note"></i>');
        }else{
            $("#mediaList").addClass('hide');
			$("#mediaListToggle").html('<i class="bi bi-music-note-list"></i>');
        }
    });
	$(document).on("change", "#mediaPlayerSelector", function(e) {
        var files = this.files;
        $("#mediaPlayerAudio").attr("src", URL.createObjectURL(files[0]));
        $("#mediaPlayerAudio")[0].play();
    });
    $(document).on("click", ".mediaPlayerStarter", function(e) {
        if ($('#mediaPlayerAudio').prop("paused") == true){
            $("#mediaPlayerAudio")[0].play();
			$("#mediaPlayerStarter").html('<i class="bi bi-pause-fill"></i>');
			$("#spectrumeBass").removeClass('paused');
        }else{
            $("#mediaPlayerAudio")[0].pause();
			$("#mediaPlayerStarter").html('<i class="bi bi-play-fill"></i>');
			$("#spectrumeBass").addClass('paused');
        }
    });
</script>
<script type="text/javascript">
    let canvas; let fft; let audioElement
	let teethRatio = 8; let teethMax = 1024; let teetUsed = (teethMax / teethRatio);  // Terdapat 64 teeth

    function setup() {
        canvas = createCanvas(10, 10);
        canvas.position(0, 0);
        canvas.style('pointer-events', 'none');

        fft = new p5.FFT(0.78);
        let context = getAudioContext();
        for (let elem of selectAll('audio')) {
            let mediaSource = context.createMediaElementSource(elem.elt);
            mediaSource.connect(p5.soundOut);
        }
		peakDetect = new p5.PeakDetect();
		audioElement = document.getElementById('mediaPlayerAudio');
		// Init DOM untuk spectrume sebanyak teeth yang dipakai
		for (let index = 0; index < teetUsed; index++) {
			let rot = ((360)/teetUsed)*index;
			$(".spectrume").append(`<li class="teeth-${index}" style="transform:rotate(${rot}deg);"></li>`);
		}
		
    }

    function touchStarted() {
        getAudioContext().resume();
    }

	let count_delay = 0; let tick = 0;
    function draw() {
        let spectrum = fft.analyze();
        let waveform = fft.waveform();

		// Audio Progress Bar, biar lengkap
		let musicCurrentTime = audioElement.currentTime;
		let musicDuration = audioElement.duration;
		let musicProgress = (musicCurrentTime/musicDuration) * 100;
		$("#mediaPlayerAudioProgress").css('--progress', `${musicProgress}%`);
		$("#mediaPlayerAudioProgressTextCurrent").html(`${musicProgress.toFixed(2)}`);

		// Spectrume Bars
		let beat_base = spectrum; let beat_temp = 0; let beat_length = beat_base.length;
		let beat_repeat = Math.round(teetUsed / 5); // teetUsed/{bebas}

		// Teeth
		let teethSelected = 0;
		for (let i = 0; i < (teetUsed); i++) { teethSelected ++;
			if (teethSelected % beat_repeat == 0) { teethSelected = teethSelected - beat_repeat; }
			beat_teeth = beat_base[ teethRatio * (teethSelected) ];
			
			let teethPos = i;
			let teethHeight = (100 + ( (beat_teeth/2) * (beat_teeth/150) ));
			let teethOpaque = 0 + ((beat_teeth/255) * 0.6);
			$("#spectrumeBeat li").eq((teethPos)).css("height",`${teethHeight}px`);
			$("#spectrumeBeat li").eq(teethPos).css("opacity",`${(teethOpaque)}`);

			// Overlay Spectrum (Heavy)
			// $("#spectrumeBeatOverlay li").eq((teethPos)).css("height",`${teethHeight/1.1}px`);
			// $("#spectrumeBeatOverlay li").eq(teethPos).css("opacity",`${(teethOpaque/3)}`);
		}
		
		// Bass dari spectrum
		let bass_base = spectrum; let bass_temp = 0; let bass_length = bass_base.length;
		for (let i = 0; i < (bass_length); i++) {
            bass_temp += (bass_base[i] / 600);
        }
		bass_temp = (bass_temp / bass_length)*0.1;

		// Bass dari WaveForm
		let wave_temp = 0;
		for (let i = 0; i < (waveform.length); i++) {
            wave_temp += (waveform[i] / 600);
        }
		wave_temp = (wave_temp / waveform.length)*0.1;

		// Bass dari beberapa Frekuensi
		bassEnergy = fft.getEnergy("bass");
		lowMidEnergy = fft.getEnergy("lowMid");
		midEnergy = fft.getEnergy("mid");
		highMidEnergy = fft.getEnergy("highMid");
		trebleEnergy = fft.getEnergy("treble");

		bass_e = (bassEnergy/512) * 0.2;
		gitar_e = (lowMidEnergy/512) * 0.1;
		snare_e = (midEnergy/512) * 0.1;
		simbal_e = (highMidEnergy/512) * 0.15;
		treble_e = (trebleEnergy/512) * 0.15;

		$("#bassEnergy").html((bass_e*1516).toFixed(0));
		$("#gitarEnergy").html((gitar_e*1516).toFixed(0));
		$("#snareEnergy").html((snare_e*1516).toFixed(0));
		$("#simbalEnergy").html((simbal_e*1516).toFixed(0));
		$("#trebleEnergy").html((treble_e*1516).toFixed(0));

		// DOM Manipulate spectrum bar secara langsung
		let bassStrength = bass_e + treble_e + gitar_e + snare_e + simbal_e;
		$("#spectrumeBass").css("transform", `scale(${(1.2-(bassStrength))})`);
		$("#spectrumeBassOverlay").css("transform", `scale(${(1.2-bassStrength/1.3)})`);

		// LR Flash
		// $("#flash").css("background", `linear-gradient(90deg, rgba(255,255,255,${(bass_e * 15)}) 0%, rgba(255,255,255,0) 30%, rgba(255,255,255,0) 70%, rgba(255,255,255,${(bass_e * 15)}) 100%)`);
		// Bottom Flash
		// $("#flash").css("background", `linear-gradient(180deg, rgba(255,255,255,0) 0%, rgba(255,255,255,${(bass_e * 30)}) 100%)`);
		// Center Flash
		$("#flash").css("background", `radial-gradient(circle, rgba(255,255,255,${(bassStrength * 3)}) 0%, rgba(255,255,255,0) 100%)`);
		
		// Debugging
		if (count_delay > 60){
			tick ++;
			count_delay = 0;
		}else{
			count_delay ++;
		}
    }
</script>
</html>
