<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="google" content="notranslate" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
	<meta name="title" content="GreenRunchly">
	<meta name="author" content="Rizki Irfan Anshori">
	<link rel="icon" href="assets/characters/greenrunchly/me.png">

	<title>GreenRunchly</title>

	<meta property="og:site_name" content="GreenRunchly">
    <meta property="og:title" content="GreenRunchly" />
    <meta property="og:description" content="Personal Audio Visualizer" />
    <meta property="og:image" itemprop="image" content="assets/me.png">
    <meta property="og:type" content="website" />

	<!-- Bootstrap Style -->
    <link href="assets/css/bootstrap-5.3.2-dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="assets/css/bootstrap-5.3.2-dist/js/bootstrap.bundle.min.js"></script>
	<link rel="stylesheet" href="assets/css/bootstrap-icons-1.11.3/font/bootstrap-icons.min.css">
	
	<!-- JQuery -->
	<script src="assets/js/jquery-3.5.1.min.js"></script>
    <script src="assets/js/jquery.countdown.js"></script>

	<!-- DB Framework -->
	<script src="assets/js/localforage/dist/localforage.js"></script>

	<!-- JSMedia -->
	<script src="https://cdnjs.cloudflare.com/ajax/libs/jsmediatags/3.9.5/jsmediatags.min.js"></script>

    <!-- P5 -->
    <script src="assets/js/p5.js"></script>
    <script src="assets/js/p5.sound.js"></script>   
</head>
<style>
    :root{
        --bs-border-radius: 1rem;

        --music-theme-color: #000000;

        --music-progress:100%;
        --music-progress-bar-color: #ffffff;

        --music-obj-pos-left: 0px;
        --music-obj-pos-top: 0px;
        --music-obj-rotate: 120deg;
        --music-obj-size: 100px;

        --music-obj-width: 3px;
        --music-obj-height: 10px;        
        --music-obj-color: #ffffff8a;
        --music-obj-outline-color: #ffffff;
        --music-obj-outline-size: 0px;
        --music-obj-shadow-size: 50px;
        --music-obj-shadow-strength: 1;
    }
    #defaultCanvas0{
        display: none;
    }
    .custom-range::-webkit-slider-runnable-track{
        background-color: #ffffff00;
        width: 100%;
        border-radius: 7px;
        border:1px solid var(--music-progress-bar-color);
		height: 9px;
    }
    .custom-range::-webkit-slider-thumb {
        background: var(--bs-light);
        width:15px;
        height: 20px;
    }
    .custom-range::-ms-fill-lower {
      background: #ddd;
      border-radius: 5px;
    }
    .custom-range::-ms-fill-upper {
      background: #ddd;
      border-radius: 5px;
    }
    ::-webkit-scrollbar {
        width: 7px;
    }
    ::-webkit-scrollbar-track {
        background-color: #ffffff00;
        width: 100%;
        border-radius: 7px;
        border:1px solid var(--music-progress-bar-color);
		height: 9px;
    }
    ::-webkit-scrollbar-thumb {
        border-radius: 10px;
        background-color: var(--bs-light);
    }
    .bi{
        /* -webkit-text-stroke: 1px; */
    }
    .bg-blur{
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px); /* For Safari */
    }
    html{
        height: 100vh;
    }
	body{
		margin: 0px;
		padding: 0px;
        height: 100vh;
        width: 100vw;
        max-width: 100vw;
		background-color: var(--music-theme-color);
	}
    .form-label{
        margin-bottom: 0px;
    }
	.main{
        position: absolute;
        --main-layout-width: 600px;
        --main-layout-height: 400px;
        --main-layout-scale: 1;
        --main-layout-rotate: 1;
        --main-layout-color: #ffffff00;
        --main-layout-opacity: 1;

        display: block;
        min-width: var(--main-layout-width);
		width: var(--main-layout-width);
        height: var(--main-layout-height);
		max-height: var(--main-layout-height);
        background-color: var(--main-layout-color);
        transform: rotate(var(--main-layout-rotate)) scale(var(--main-layout-scale));
        opacity: var(--main-layout-opacity);
        border: 1px solid #ffffff00;
	}
    .main:hover{
        /* border: 1px solid #ffffff; */
    }

	.music.progress-bar{
        display: block;
        width: 100%;
        border-radius: 7px;
        border:1px solid var(--music-progress-bar-color);
		height: 9px;
	}
	.music.progress-bar .bar{
        display: flex;
		width: calc(var(--music-progress));
		min-width: 0px;
        height: 100%;
		transition: 1s;
        background-color: var(--music-progress-bar-color);
	}

	.music.spectrume{
        position: relative;
        --music-obj-rotate: 0deg;
        --music-obj-scale: 1;
        --music-obj-pos-left: 0px;
        --music-obj-pos-top: 0px;

        left: var(--music-obj-pos-left);
        top: var(--music-obj-pos-top);
		display: flex;
		align-items: flex-end;
		list-style-type: none;
		margin: 0rem;
		padding: 0rem;
        transform: rotate(var(--music-obj-rotate)) scale(var(--music-obj-scale));
        transform-origin: 0%;
	}
	.music.spectrume li{
        --music-obj-rotate: 0deg;
        --music-obj-distance: 120px;
        --music-obj-height: 12px;
        --music-obj-width: 4px;
        --music-obj-color: #ffffff; 
        --music-obj-outline-width: 1px;
        --music-obj-outline-color: #ffffff;
        --music-obj-shadow-spread: 0px;
        --music-obj-shadow-color: #ffffff;
        --music-obj-opacity: 0; 
        --music-obj-shape-radius: 1rem;

		position: absolute;
        padding-bottom: var(--music-obj-height);
		width: var(--music-obj-width);
		background-color: var(--music-obj-color);
        border: var(--music-obj-outline-width) solid var(--music-obj-outline-color);
        box-shadow: 0 0 var(--music-obj-shadow-spread) var(--music-obj-shadow-color), 0 0 var(--music-obj-shadow-spread) var(--music-obj-shadow-color), 0 0 var(--music-obj-shadow-spread) var(--music-obj-shadow-color);
        transform: rotate(var(--music-obj-rotate)) translateY(var(--music-obj-distance));
        transform-origin: 0% 100%;
        border-radius: var(--music-obj-shape-radius);

        --music-obj-active-height: 0px;
        --music-obj-active-opacity: 1;
        opacity: var(--music-obj-active-opacity);
        padding-top: var(--music-obj-active-height);
    }

    .music.image{
        --music-obj-width: 250px;
        --music-obj-height: 250px;
        --music-obj-scale: 1;
        --music-obj-rotate: 0deg;
        --music-obj-opacity: 1; 
        --music-obj-pos-left: 0px;
        --music-obj-pos-top: 0px;

        position: relative;
        left: var(--music-obj-pos-left);
        top: var(--music-obj-pos-top);
        width: calc(var(--music-obj-width));
        height:var(--music-obj-height);
        transform: rotate(var(--music-obj-rotate)) scale(var(--music-obj-scale));
        transform-origin: 50%;
        opacity: var(--music-obj-opacity);
    }
    
</style>
<body class="overflow-hidden">
	<main class="container-fluid">
		<div class="container" style="height: 100dvh; width: 100%; max-height: 100dvh; max-width: 500px;">
            <div class="row g-2 d-flex flex-column h-100">
                <div class="col-12">
                    <div class="container collapse main-panel show">
                        <div class="row g-2">
                            <div class="col-12 d-flex">
                                <!-- Filler saja -->
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col py-4 d-flex justify-content-center align-items-center z-0 ">
                    <div class="position-absolute d-flex justify-content-center align-items-center overflow-hidden" style="height: 100vh; width:100vw;">
                        <div class="main rounded-5" data-bs-toggle="collapse" data-bs-target=".main-panel" role="button" >
                        
                        </div>
                    </div>
                </div>
                <div class="col-12 z-1 user-select-none">
                    <div class="collapse main-panel show">
                        <div class="row">
                            <div class="col-12">
                                <div class="collapse control-panel design-panel library-panel show">
                                    <div class="row">
                                        <div class="col-12 d-flex ">
                                            <div id="mediaControlPanelPartAction" class="collapse show mx-auto z-3">
                                                <button class="btn btn-md rounded-5 btn-light me-4 ms-auto" data-bs-toggle="collapse" data-bs-target=".library-panel" role="button">
                                                    <p class="m-0 text-truncate">
                                                        <i class="bi bi-music-note-beamed"></i>
                                                    </p>
                                                </button>
                                                <button class="btn btn-lg rounded-5 btn-light action-mediaplayer fs-2" data-bs-toggle="collapse" data-bs-target=".main-panel" role="button">
                                                    <p class="m-0 text-truncate">
                                                        <i class="bi bi-play-fill"></i>
                                                    </p>
                                                </button>
                                                <button class="btn btn-md rounded-5 btn-light ms-4 me-auto" data-bs-toggle="collapse" data-bs-target=".design-panel" role="button">
                                                    <p class="m-0 text-truncate">
                                                        <i class="bi bi-brush"></i>
                                                    </p>
                                                </button>
                                            </div>
                                        </div>
                                        <div class="col-12 mt-2">
                                            <div id="mediaControlPanelPartMeta" class="collapse show">
                                                <audio class="d-none" id="mediaPlayerAudio" controls>
                                                    <source src="assets/audio/Nightcore Ruth - Dendalions.mp3" type="audio/mpeg">
                                                </audio>
                                                <a class="btn btn-sm text-white text-center w-100">
                                                    <p class="m-0 text-truncate fs-6">
                                                        <span id="mediaPlayerPlayingTitle">Ruth - Dendalions [Nightcore]</span>
                                                    </p>
                                                </a>
                                                <div class="music progress-bar rounded-5 my-2">
                                                    <div class="bar rounded-5"></div>
                                                </div>
                                                <a class="btn btn-sm text-white text-center w-100" href="https://greenrunchly.my.id">
                                                    <p class="m-0 text-truncate">
                                                        <small>&copy2024 GreenRunchly</small>
                                                    </p>
                                                </a>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-12">
                                <div class="collapse library-panel border border-ligth bg-light bg-opacity-10 bg-blur rounded-4">
                                    <div class="row px-2 py-3">
                                        <div class="col-12 text-white">
                                            <div id="librayControlPanelPartImporter" class="collapse show">
                                                <div class="container overflow-y-scroll" style="max-height: 200px;">
                                                    <div class="row g-2" id="musicControlPanelPartListing">
                                                        <!-- Automatic Coy -->
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col py-3">
                                            <div class="border-bottom w-75 mx-auto"></div>
                                        </div>
                                        <div class="col-12">
                                            <div class="container pe-3">
                                                <div class="row g-2">
                                                    <div class="col-12 col-sm d-flex justify-content-start">
                                                        <a class="btn btn-light px-3 rounded-5 w-100 text-start">
                                                            <p class="m-0 text-truncate fw-bold">
                                                                <i class="bi bi-music-note-beamed me-2"></i> <span>Music Library</span>
                                                            </p>
                                                        </a>
                                                    </div>
                                                    <div class="col-6 col-sm-auto d-flex justify-content-start">
                                                        <label for="mediaPlayerAudioImporter" class="btn btn-light px-3 rounded-5 w-100">
                                                            <p class="m-0 text-truncate">
                                                                <i class="bi bi-plus"></i> <span>Import</span>
                                                            </p>
                                                        </label>
                                                        <input class="form-control d-none" type="file" id="mediaPlayerAudioImporter" accept="audio/*" webkitdirectory directory multiple />
                                                    </div>
                                                    <div class="col-6 col-sm-auto pe-2">
                                                        <button class="btn btn-light px-3 rounded-5 w-100" data-bs-toggle="collapse" data-bs-target=".library-panel" role="button">
                                                            <p class="m-0 text-truncate">
                                                                <i class="bi bi-chevron-left"></i> <span>Back</span>
                                                            </p>
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="collapse design-panel border border-light bg-light bg-opacity-10 bg-blur rounded-4">
                                    <div class="row px-2 py-3">                                        
                                        <div class="col-12 text-white">
                                            <div id="designControlPanelPartLayout" class="collapse show">
                                                <div class="container overflow-y-scroll" style="max-height: 300px;">
                                                    <div class="row g-2" id="designControlPanelPartObjects">
                                                        <!-- Automatic Coy -->
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col py-3">
                                            <div class="border-bottom w-75 mx-auto"></div>
                                        </div>
                                        <div class="col-12">
                                            <div class="container pe-3">
                                                <div class="row g-2">
                                                    <div class="col-12 col-sm d-flex justify-content-start">
                                                        <a class="btn btn-light px-3 rounded-5 w-100 text-start">
                                                            <p class="m-0 text-truncate fw-bold">
                                                                <i class="bi bi-brush me-2"></i> <span>Visual Designer</span>
                                                            </p>
                                                        </a>
                                                    </div>
                                                    <div class="col col-sm-auto d-flex justify-content-start">
                                                        <label for="objectDesignImporter" class="btn btn-light px-3 rounded-5 w-100 ">
                                                            <p class="m-0 text-truncate">
                                                                <i class="bi bi-upload"></i> <span></span>
                                                            </p>
                                                        </label>
                                                        <input class="form-control d-none action-designer-object-load" type="file" id="objectDesignImporter" accept=".json,application/json" />
                                                    </div>
                                                    <div class="col col-sm-auto d-flex justify-content-start">
                                                        <a class="btn btn-light px-3 rounded-5 w-100 action-designer-object-save" role="button">
                                                            <p class="m-0 text-truncate">
                                                                <i class="bi bi-download"></i> <span></span>
                                                            </p>
                                                        </a>
                                                    </div>
                                                    <div class="col-6 col-sm-auto pe-2">
                                                        <button class="btn btn-light px-3 rounded-5 w-100" data-bs-toggle="collapse" data-bs-target=".design-panel" role="button">
                                                            <p class="m-0 text-truncate">
                                                                <i class="bi bi-chevron-left"></i> <span>Back</span>
                                                            </p>
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div> 
                                </div> 
                            </div>
                        </div>
                    </div>
                </div>     
            </div>
        </div>
	</main>
</body>
<script>
    // Default objectMemory
    let objectMemory = {}; 
    let objectMemoryDefault = JSON.parse(JSON.parse(JSON.stringify(`
        {"layoutGlobal":{"id":"layoutGlobal","tipe":100,"nama":"Layout","params":{"width":600,"height":400,"scale":1,"scaleDynamic":0,"opacity":1,"opacityDynamic":0,"color":"#39b054","rotate":0},"paramsThresholdMin":{"width":0,"height":0,"scale":-2,"scaleDynamic":-1,"opacity":0,"opacityDynamic":0,"color":null,"rotate":-360},"paramsThresholdMax":{"width":1000,"height":1000,"scale":2,"scaleDynamic":1,"opacity":1,"opacityDynamic":2,"color":null,"rotate":360}},"imageGlobal":{"id":"imageGlobal","tipe":2,"nama":"Image","params":{"image":"","width":350,"height":350,"posX":125,"posY":25,"scale":1,"scaleDynamic":0.1,"rotate":0,"opacity":1,"opacityDynamic":0},"paramsThresholdMin":{"image":null,"width":0,"height":0,"posX":-500,"posY":-500,"scale":-2,"scaleDynamic":-1,"rotate":-360,"opacity":0,"opacityDynamic":0},"paramsThresholdMax":{"image":null,"width":1000,"height":1000,"posX":500,"posY":500,"scale":2,"scaleDynamic":1,"rotate":360,"opacity":1,"opacityDynamic":3}},"spectrumGlobal":{"id":"spectrumGlobal","tipe":1,"nama":"Spectrume","params":{"bars":"61.3","barsColor":"#ffffff","barsRadius":1,"outlineWidth":"2.8","outlineColor":"#ffffff","shadowSpread":0,"shadowColor":"#ffffff","repeat":2,"width":"5.04","thick":20,"posX":300,"posY":200,"opacity":"0.26","opacityDynamic":"2.4","scale":1,"scaleDynamic":0.1,"rotate":-55,"distance":-120,"distanceDynamic":"30","strength":"1230","sensitivity":"270"},"paramsThresholdMin":{"bars":1,"barsColor":null,"barsRadius":0,"outlineWidth":0,"outlineColor":null,"shadowSpread":0,"shadowColor":null,"repeat":1,"width":1,"thick":0,"posX":-500,"posY":-500,"opacity":0,"opacityDynamic":0,"scale":-2,"scaleDynamic":-1,"rotate":-360,"distance":-300,"distanceDynamic":-150,"strength":0,"sensitivity":0},"paramsThresholdMax":{"bars":200,"barsColor":null,"barsRadius":2,"outlineWidth":10,"outlineColor":null,"shadowSpread":64,"shadowColor":null,"repeat":12,"width":100,"thick":100,"posX":500,"posY":500,"opacity":1,"opacityDynamic":3,"scale":2,"scaleDynamic":1,"rotate":360,"distance":300,"distanceDynamic":150,"strength":1500,"sensitivity":1500}}}    
    `)));
    objectMemory = objectMemoryDefault;  
    
    // Setel Koneksi Database
	let spectrumStorage = localforage.createInstance({
        name: "spectrumStorage"
    });

    // Setel Koneksi Database
	let musicStorage = localforage.createInstance({
        name: "musicStorage"
    });

    // Setel Koneksi Database
	let musicMetaStorage = localforage.createInstance({
        name: "musicMetaStorage"
    });
</script>
<script>
    $('#mediaPlayerAudioImporter').on('change', function(event) {
        const files = event.target.files; 

        // Function menambahkan musik ke library
		function tambahMusik(file, fileUniqueID, fileMetadata, fullTitle) {
			return new Promise((resolve, reject) => {
				// Menyimpan Metadata Ke Database
				musicMetaStorage.setItem(fileUniqueID, fileMetadata).then(async function () {
					// Konversi File ke Base64
					let tempFileBuffer = await file2Base64(file);

					// Menyimpan File Ke Database
					musicStorage.setItem(fileUniqueID, tempFileBuffer).then(function () {
						resolve(); console.log('Tersimpan!');
					}).catch(function (err) {
						reject(); console.log(err);
					});
				}).catch(function (err) {
					reject(); console.log(err);
				});
			});
		}

		// Proses Menyimpan (didelay 2 Detik)
		setTimeout(() => {
            // Proses Menyimpan (Delay 2 Detik)
		    let diupload = 0; let diantrian = 0; let diimpor = 0; 
			// Iteration file (melakukan scan)
			$.each(files, async function(index, file) {
				if (((file.size > (1 * 1024 * 1024))) && (isAudioFile(file))){ 
					// Detail File
                    let fileUniqueID = file.size.toString();
					let fileName = file.name;
					let fileExt = file.name.split('.').pop().toLowerCase();
					let fileSize = file.size;

					let title, artist; title = fileName; artist = fileUniqueID;
					let fullTitle = `${artist} - ${title}`;

					// Membaca Metadata File
					await jsmediatags.read(file, {
						onSuccess: async function(tag) {
							(tag.tags.title) ? title = tag.tags.title : title  = fileName; (tag.tags.artist) ? artist = tag.tags.artist : artist = fileUniqueID;
							let fullTitle = `${artist} - ${title}`;
							let fileMetadata = {title:title, artist:artist, fullTitle:fullTitle};
							
							// Menambahkan Musik
							try {
								await setTimeout( async () => {
									let result = await tambahMusik(file, fileUniqueID, fileMetadata, fullTitle);
									diimpor ++;
								}, 1000);
							} catch (error) {
								// Gagal Menambahkan
								console.error(error);
								diimpor ++;
							}
						},
						onError: async function(error) {
							let fileMetadata = {title:title, artist:artist, fullTitle:fullTitle};
							
							// Menambahkan Musik
							try {
								await setTimeout( async () => {
									let result = await tambahMusik(file, fileUniqueID, fileMetadata, fullTitle);
									diimpor ++;
								}, 1000);
							} catch (error) {
								// Gagal Menambahkan
								console.error(error);
								diimpor ++;
							}
						}
					});
					diantrian ++;
				}
				diupload ++;
			});

			let waitingScanner = setInterval(() => {
				console.log('Scanning...', diupload, diantrian, diimpor);
				if (diantrian == diimpor) {
					loadListingMusik();
                    clearInterval(waitingScanner);
					console.log('Scan Done!', diimpor);
				}
			}, 100);
		}, 2000);
    });
    
    // Preload Music Listing
	function loadListingMusik() {
		$("#musicControlPanelPartListing").empty();
		// Membaca Database
		musicMetaStorage.iterate(function(musicMeta, key, iterationNumber) {
			let title = musicMeta.fullTitle;
			$("#musicControlPanelPartListing").prepend(`
				<div class="col-12">
					<div class="row g-2">
						<div class="col">
							<a class="btn btn-outline-light text-start w-100 select-music" music-number="${key}">
								<p class="m-0 text-truncate">
                                    <span>${title}</span>
                                </p>
							</a>
						</div>
					</div>
				</div>
			`); 
			console.log('Listing Musik selesai')
		}).then(function() {
			
		}).catch(function(err) {
			
			console.error("Error during iteration", err);
		});
	}

    // Tombol Aksi Load Object
    $(document).on("click", ".select-music", async function(e) {
        let musicID = $(this).attr('music-number');
		
		musicMetaStorage.getItem(musicID).then(function (musicMeta) {
			let title = `${musicID}`;
			if (musicMeta.title){
				title = `${musicMeta.artist} - ${musicMeta.title}`;
			}
			$("#mediaPlayerPlayingTitle").html(title);
            $(`.select-music`).removeClass('btn-light text-black');
            $(`.select-music`).addClass('btn-outline-light');
            $(`.select-music[music-number=${musicID}]`).addClass('btn-light text-black');
			musicStorage.getItem(musicID).then(function (music) {
				$("#mediaPlayerAudio").attr("current-media", musicID);
				$("#mediaPlayerAudio").attr("src", music);
				$("#mediaPlayerAudio")[0].play();
			}).catch(function (err) {
				console.log(err);
			});
		}).catch(function (err) {
			console.log(err);
		});
    });

    loadListingMusik();
</script>
<script>
    function isHexColor(hex) {
        const hexPattern = /^#([0-9A-F]{3}|[0-9A-F]{6})$/i;
        return hexPattern.test(hex);
    }

    function isString(value) {
        return typeof value === 'string';
    }

    function makePositive(value) {
        return Math.abs(value);
    }

    function saveJsonToFile(jsonString, filename) {
        const blob = new Blob([jsonString], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    }

    function file2Base64(file) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = () => resolve(reader.result);
            reader.onerror = error => reject(error);
        });
    }

    // Cek audio atau bukan
    function isAudioFile(file) {
        // Check MIME type
        const audioMimeTypes = [
            'audio/mpeg', // mp3
            'audio/wav',  // wav
            'audio/ogg',  // ogg
            'audio/mp4',  // mp4
            'audio/x-aiff', // aiff
            'audio/x-wav',  // wav
            'audio/webm', // webm
            'audio/flac', // flac
        ];

        if (audioMimeTypes.includes(file.type)) {
            return true;
        }

        // Check file extension as a fallback
        const audioExtensions = ['mp3', 'wav', 'ogg', 'mp4', 'aiff', 'wav', 'webm', 'flac'];
        const fileExtension = file.name.split('.').pop().toLowerCase();

        if (audioExtensions.includes(fileExtension)) {
            return true;
        }

        return false;
    }

    function encodeToBase64(input) {
        return btoa(input);
    }

    function decodeFromBase64(input) {
        return atob(input);
    }

    function getParameterByName(name, url) {
        if (!url) url = window.location.href;
        name = name.replace(/[\[\]]/g, "\\$&");
        var regex = new RegExp("[?&]" + name + "(=([^&#]*)|&|#|$)"),
            results = regex.exec(url);
        if (!results) return null;
        if (!results[2]) return '';
        return decodeURIComponent(results[2].replace(/\+/g, " "));
    }

    function getAllParameterKeys(url) {
        if (!url) url = window.location.href;
        var queryString = url.split('?')[1];
        if (!queryString) return [];

        var params = new URLSearchParams(queryString);
        var keys = [];
        params.forEach(function(value, key) {
            keys.push(key);
        });
        return keys;
    }

    // Load object to layout
    for (let key in objectMemory) {
        if (objectMemory.hasOwnProperty(key)) {
            let obj = objectMemory[key];
            
            objectStructure(obj, (objConfig) => {
                let objParamItems = ``;
                let objId = obj.id;
                let objParams = obj.params;
                let objParamsThresholdMin = obj.paramsThresholdMin;
                let objParamsThresholdMax = obj.paramsThresholdMax;

                for (let paramKey in objParams) {
                    if (objParams.hasOwnProperty(paramKey)) {
                        let paramVal = objParams[paramKey];
                        if (!isNaN(parseFloat(paramVal))){
                            paramVal = parseFloat(paramVal);
                        }

                        let ParamValMin = objParamsThresholdMin[paramKey];
                        if (!isNaN(parseFloat(ParamValMin))){
                            ParamValMin = parseFloat(ParamValMin);
                        }

                        let ParamValMax = objParamsThresholdMax[paramKey];
                        if (!isNaN(parseFloat(ParamValMax))){
                            ParamValMax = parseFloat(ParamValMax);
                        }
                        
                        if (isHexColor(paramVal) == true){
                            objParamItems += `
                            <div class="col-12 col-sm-6">
                                <label for="mainLayout${objId}" class="form-label ms-3">${paramKey}</label>
                                <input type="color" class="form-control form-control-color btn btn-md btn-light w-100 rounded-5 action-designer-object-config" id="mainLayout${objId}" 
                                designer-object-id="${objId}" designer-object-param="${paramKey}"
                                title="Set ${paramKey}">
                            </div>
                            `;
                        }else if (isString(paramVal) == true){
                            objParamItems += `
                            <div class="col-12 col-sm-6">
                                <label for="mainLayout${objId}" class="form-label ms-3">Image</label>
                                <label for="mainLayout${objId}" class="btn btn-light text-center w-100 rounded-5">
                                    <p class="m-0 text-truncate">
                                        <i class="bi bi-plus"></i> <span>Open</span>
                                    </p>
                                </label>
                                <input class="form-control d-none action-designer-object-file"  designer-object-param="image" designer-object-id="${objId}" type="file" id="mainLayout${objId}" accept="image/*" />
                            </div>
                            `;
                        }else{
                            objParamItems += `
                            <div class="col-12 col-sm-6">
                                <label for="mainLayout${objId}" class="form-label ms-3">${paramKey}</label>
                                <input type="range" class="form-range custom-range action-designer-object-config" id="mainLayout${objId}"
                                designer-object-id="${objId}" designer-object-param="${paramKey}"
                                step="${ ((ParamValMax/50) + (makePositive(ParamValMin)/50)).toFixed(2) }" min="${ParamValMin}" max="${ParamValMax}">
                            </div>
                            `;
                        }
                        

                    }
                }
                return objParamItems;
            });
        }
    }

    function objectStructure(objConfig, objectStructureItems) {
        let objId = objConfig.id;
        let objNama = objConfig.nama;

        let layoutDesignerObject = ``;
        layoutDesignerObject += `
            <!-- Object -->
            <div class="col-12">
                <div class="row g-2">
                    <div class="col col-sm d-flex justify-content-start">
                        <a class="btn btn-light px-3 rounded-5 w-100 text-start" data-bs-toggle="collapse" data-bs-target=".design-obj-${objId}">
                            <p class="m-0 text-truncate fw-bold">
                                <i class="bi bi-box me-2"></i> <span>${objNama}</span>
                            </p>
                        </a>
                    </div>
                    <div class="col-auto col-sm-auto d-flex justify-content-start">
                        <a class="btn btn-danger px-3 rounded-5 w-100 action-designer-object-reset" designer-object-id="${objId}" role="button">
                            <p class="m-0 text-truncate">
                                <i class="bi bi-arrow-clockwise"></i> <span>Reset</span>
                            </p>
                        </a>
                    </div>
                    <div class="col-12">
                        <div class="design-obj-${objId} container collapse border border-light rounded-4">
                            <div class="row py-2">
        `;
        layoutDesignerObject += objectStructureItems(objConfig);
        layoutDesignerObject += `
                            </div>
                        </div>
                    </div>
                </div>                                                            
            </div>
            <!-- Object -->
        `;
        $(`#designControlPanelPartObjects`).prepend(layoutDesignerObject);
    }       

</script>
<script>
    async function initGlobal() {
        let key = getAllParameterKeys();
        let profile = (key[0]) ? key[0] : null;

        // Load saved objectMemory
        if (profile !== null) {
            $.ajax({
                url: `profile/spectrum-profile-${profile}.json`,
                success: function(result) {
                    // Success callback
                    objectMemory = JSON.parse(JSON.stringify(result));
                    saveObject();
                    window.location = '?';
                },
                error: function(xhr, status, error) {
                    // Error callback
                    console.error('Error fetching profile data:', status, error);
                    // Handle the error here (e.g., show a message to the user)
                }
            });
        }else{
            json = await loadObject();
            if (json !== null){
                objectMemory = json;
            }
        }
    }
    initGlobal()

    async function saveObject() {
        // Menyimpan Metadata Ke Database
        await spectrumStorage.setItem('objectMemory', objectMemory).then(async function () {
            console.log('Tersimpan');
        }).catch(function (err) {
            console.log(err);
        });
    }

    async function loadObject() {
        try {
            const objectMemory = await spectrumStorage.getItem('objectMemory');
            console.log(objectMemory)
            return objectMemory;
        } catch (err) {
            console.log(err);
            return null;
        }
    }
    
    async function initObject() {
        // Clean object from layout
        $(`.main`).empty();

        // Load object to layout
        for (let key in objectMemory) {
            if (objectMemory.hasOwnProperty(key)) {
                let item = objectMemory[key];
                switch (item.tipe) {
                    case 100:
                        mainLayoutSet(item);
                        break;
                    case 2:
                        objImageAdd(item);
                        break;
                    case 1:
                        objSpectrumAdd(item);
                        break;
                }
            }
        }

        // console.log('Current', objectMemory);
        // console.log('Restore point', objectMemoryDefault);
        
        // Simpan objectMemory
        saveObject();
    }

    function rebuildObjectConfig(objConfig) {
        // Read Data
        let objId                   = objConfig.id;
        let objParams               = objConfig.params;

        // Set object at designer config on each object 
        for (let param in objParams) {
            if (objParams.hasOwnProperty(param)) {
                let paramValue = objParams[param];
                $(`.action-designer-object-config[designer-object-id="${objId}"][designer-object-param="${param}"]`).val(paramValue);
            }
        }
    }

    function mainLayoutSet(objConfig=[], location='') {
        // Read Data
        let objId                   = objConfig.id;
        let objParams               = objConfig.params;

        // Set Parameters
        let objParamWidth           = float(objParams.width);
        let objParamHeight          = float(objParams.height);
        let objParamScale           = float(objParams.scale);
        let objParamScaleDynamic    = float(objParams.scaleDynamic);
        let objParamRotate          = float(objParams.rotate);
        let objParamColor           = objParams.color;
        let objParamOpacity         = float(objParams.opacity);
        let objParamOpacityDynamic  = float(objParams.opacityDynamic);

        $(`.main`).attr('id', `objectId${objId}`);
        $(`body`).css('--music-theme-color', `${objParamColor}`);

        $(`#objectId${objId}`).css('--main-layout-width', `${objParamWidth}px`);
        $(`#objectId${objId}`).css('--main-layout-height', `${objParamHeight}px`);
        $(`#objectId${objId}`).css('--main-layout-scale', `${objParamScale}`);
        $(`#objectId${objId}`).css('--main-layout-rotate', `${objParamRotate}deg`);
        $(`#objectId${objId}`).css('--main-layout-opacity', `${objParamOpacity}`);
        
		
        rebuildObjectConfig(objConfig);
    }

    function mainLayoutUpdate(objConfig=[], objFlow) {
        // Read Data
        let objId                   = objConfig.id;
        let objParams               = objConfig.params;
        let objFlowEnergy           = objFlow.energy;

        // Set Parameters
        let objParamWidth           = float(objParams.width);
        let objParamHeight          = float(objParams.height);
        let objParamScale           = float(objParams.scale);
        let objParamScaleDynamic    = float(objParams.scaleDynamic);
        let objParamRotate          = float(objParams.rotate);
        let objParamColor           = objParams.color;
        let objParamOutlineColor    = objParams.outlineColor;
        let objParamOpacity         = float(objParams.opacity);
        let objParamOpacityDynamic  = float(objParams.opacityDynamic);
        
        // Data Flow
        let dataScale = objParamScale + (objFlowEnergy * objParamScaleDynamic);
        $(`#objectId${objId}`).css('--main-layout-scale', `${dataScale}`);

        let dataOpacity = objParamOpacity + (objFlowEnergy * (objParamOpacityDynamic));
        $(`#objectId${objId}`).css('--main-layout-opacity', `${dataOpacity}`);

        $(`#objectId${objId}`).css('--main-layout-rotate', `${objParamRotate}deg`);
        $(`#objectId${objId}`).css('--main-layout-outline-color', `${objParamOutlineColor}`);

        $(`body`).css('--music-theme-color', `${objParamColor}`);
    }

    function objImageAdd(objConfig=[], location='') {
        // Read Data
        let objId                   = objConfig.id;
        let objParams               = objConfig.params;

        // Set Parameters
        let objParamImage           = objParams.image;
        let objParamWidth           = float(objParams.width);
        let objParamHeight          = float(objParams.height);
        let objParamPosX            = float(objParams.posX);
        let objParamPosY            = float(objParams.posY);
        let objParamScale           = float(objParams.scale);
        let objParamScaleDynamic    = float(objParams.scaleDynamic);
        let objParamRotate          = float(objParams.rotate);
        let objParamOpacity         = float(objParams.opacity);
        let objParamOpacityDynamic  = float(objParams.opacityDynamic);

        // Add base object
        $(`.main ${location}`).prepend(`
            <img src="${objParamImage}" class="music image p-0 m-0" id="objectId${objId}" draggable="false"
            style="
            --music-obj-width:${objParamWidth}px;
            --music-obj-height:${objParamHeight}px;
            --music-obj-pos-left:${objParamPosX}px;
            --music-obj-pos-top:${objParamPosY}px;
            --music-obj-scale:${objParamScale};
            --music-obj-rotate:${objParamRotate}deg;
            --music-obj-opacity:${objParamOpacity};
            ">
        `);

        rebuildObjectConfig(objConfig);
    }

    function objImageUpdate(objConfig=[], objFlow) {
        // Read Data
        let objId                   = objConfig.id;
        let objParams               = objConfig.params;
        let objFlowEnergy           = objFlow.energy;

        // Set Parameters
        let objParamImage           = objParams.image;
        let objParamWidth           = float(objParams.width);
        let objParamHeight          = float(objParams.height);
        let objParamPosX            = float(objParams.posX);
        let objParamPosY            = float(objParams.posY);
        let objParamScale           = float(objParams.scale);
        let objParamScaleDynamic    = float(objParams.scaleDynamic);
        let objParamRotate          = float(objParams.rotate);
        let objParamOpacity         = float(objParams.opacity);
        let objParamOpacityDynamic  = float(objParams.opacityDynamic);
        
        // Data Flow
        let dataScale = objParamScale + (objFlowEnergy * objParamScaleDynamic);
        $(`#objectId${objId}`).css(`--music-obj-scale`,`${dataScale}`);

        let dataOpacity = objParamOpacity + (objFlowEnergy * (objParamOpacityDynamic));
        $(`#objectId${objId}`).css(`--music-obj-opacity`,`${dataOpacity}`);

        $(`#objectId${objId}`).css(`--music-obj-width`,`${objParamWidth}px`);
        $(`#objectId${objId}`).css(`--music-obj-height`,`${objParamHeight}px`);
        $(`#objectId${objId}`).css(`--music-obj-rotate`,`${objParamRotate}deg`);
        $(`#objectId${objId}`).css(`--music-obj-pos-left`,`${objParamPosX}px`);
        $(`#objectId${objId}`).css(`--music-obj-pos-top`,`${objParamPosY}px`);
    }

    function objSpectrumAdd(objConfig=[], location='') {
        // Read Data
        let objId                   = objConfig.id;
        let objParams               = objConfig.params;

        // Set Parameters
        let objParamScale           = float(objParams.scale);
        let objParamScaleDynamic    = float(objParams.scaleDynamic);
        let objParamBars            = Math.round(objParams.bars);
        let objParamBarsColor       = objParams.barsColor;
        let objParamBarsRadius      = float(objParams.barsRadius);
        let objParamOutlineWidth    = float(objParams.outlineWidth);
        let objParamOutlineColor    = objParams.outlineColor;
        let objParamShadowSpread    = float(objParams.shadowSpread);
        let objParamShadowColor     = objParams.shadowColor;
        let objParamWidth           = float(objParams.width);
        let objParamThick           = float(objParams.thick);
        let objParamDistance        = float(objParams.distance);
        let objParamDistanceDynamic = float(objParams.distanceDynamic);
        let objParamPosX            = float(objParams.posX);
        let objParamPosY            = float(objParams.posY);
        let objParamRotate          = float(objParams.rotate);
        let objParamRepeat          = Math.round(objParams.repeat);
        let objParamStrength        = float(objParams.strength);
        let objParamSensitivity     = float(objParams.sensitivity);
        let objParamOpacity         = float(objParams.opacity);
        let objParamOpacityDynamic  = float(objParams.opacityDynamic);

        // Add base object
        $(`.main ${location}`).prepend(`
            <ul id="objectId${objId}" class="music spectrume p-0 m-0" style="
            --music-obj-pos-left:${objParamPosX}px;
            --music-obj-pos-top:${objParamPosY}px;
            --music-obj-scale:${objParamScale};
            --music-obj-rotate:${objParamRotate}deg;
            "></ul>
        `);
        
        // Add sub object dalam base
		for (let i = 0; i < objParamBars; i++) {
			let iTeethRotate = ( (360)/objParamBars ) * i;
			$(`.main ${location} #objectId${objId}`).append(`
                <li style="
                --music-obj-rotate:${iTeethRotate}deg;
                --music-obj-height:${objParamThick}px;
                --music-obj-width:${objParamWidth}px;
                --music-obj-distance:${(objParamDistance)}px;
                --music-obj-color:${objParamBarsColor}; 
                --music-obj-outline-width:${objParamOutlineWidth}px;
                --music-obj-outline-color:${objParamOutlineColor};
                --music-obj-shadow-spread:${objParamShadowSpread}px;
                --music-obj-shadow-color:${objParamShadowColor};
                --music-obj-shape-radius:${objParamBarsRadius}rem;
                "></li>
            `);
		}

        rebuildObjectConfig(objConfig);
    }

    function objSpectrumUpdate(objConfig=[], objFlow) {
        // Read Data
        let objId                   = objConfig.id;
        let objParams               = objConfig.params;
        let objFlowEnergy           = objFlow.energy;
        let objFlowSpectrum         = objFlow.spectrum;

        // Set Parameters
        let objParamScale           = float(objParams.scale);
        let objParamScaleDynamic    = float(objParams.scaleDynamic);
        let objParamBars            = Math.round(objParams.bars);
        let objParamBarsColor       = objParams.barsColor;
        let objParamBarsRadius      = float(objParams.barsRadius);
        let objParamOutlineWidth    = float(objParams.outlineWidth);
        let objParamOutlineColor    = objParams.outlineColor;
        let objParamShadowSpread    = float(objParams.shadowSpread);
        let objParamShadowColor     = objParams.shadowColor;
        let objParamWidth           = float(objParams.width);
        let objParamThick           = float(objParams.thick);
        let objParamDistance        = float(objParams.distance);
        let objParamDistanceDynamic = float(objParams.distanceDynamic);
        let objParamPosX            = float(objParams.posX);
        let objParamPosY            = float(objParams.posY);
        let objParamRotate          = float(objParams.rotate);
        let objParamRepeat          = Math.round(objParams.repeat);
        let objParamStrength        = float(objParams.strength);
        let objParamSensitivity     = float(objParams.sensitivity);
        let objParamOpacity         = float(objParams.opacity);
        let objParamOpacityDynamic  = float(objParams.opacityDynamic);
        
        // Data Flow
        let dataDistance = objParamDistance + (objFlowEnergy * objParamDistanceDynamic);
        $(`#objectId${objId} li`).css(`--music-obj-distance`,`${dataDistance}px`);

        let dataScale = objParamScale + (objFlowEnergy * objParamScaleDynamic);
        $(`#objectId${objId}`).css(`--music-obj-scale`,`${dataScale}`);

        let dataSpectrum = objFlowSpectrum;
        let dataSpectrumBarRepeatThreshold = Math.round(objParamBars / objParamRepeat); 
        let dataSpectrumBarBufferActive = 0;

        for (let i = 0; i < (objParamBars); i++) {  dataSpectrumBarBufferActive ++;
            if (dataSpectrumBarBufferActive % dataSpectrumBarRepeatThreshold == 0) { 
                dataSpectrumBarBufferActive = dataSpectrumBarBufferActive - dataSpectrumBarRepeatThreshold; 
            }
            let dataSpectrumeBarBufferAudio = dataSpectrum[ Math.round(mediaSpectrume / objParamBars) * dataSpectrumBarBufferActive ];
            let objBufferBarPos = i;
            
            let dataSpectrumMultiplier = ( Math.pow(dataSpectrumeBarBufferAudio/255, (1000/objParamSensitivity) )) * (objParamStrength/1000);
            let dataSpectrumMultiplierMax = ( Math.pow(1, (1000/objParamSensitivity) )) * (objParamStrength/1000);

            let objBufferBarHeight = (dataSpectrumeBarBufferAudio) * dataSpectrumMultiplier;
            $(`#objectId${objId} li`).eq((objBufferBarPos)).css("--music-obj-active-height",`${objBufferBarHeight}px`);

            let objBufferBarOpacity = (objParamOpacity) + ((dataSpectrumMultiplier / dataSpectrumMultiplierMax) * (objParamOpacityDynamic));
            $(`#objectId${objId} li`).eq((objBufferBarPos)).css("--music-obj-active-opacity",`${objBufferBarOpacity}`);            
        }
    }
</script>
<script type="text/javascript">
    let canvas; let fft; let audioElement; let mediaSpectrume = 1024;
    let count_delay = 0;

    function setup() {
        // Memulai listener spectrum audio pada base
        fft = new p5.FFT(0.78);
        let context = getAudioContext();
        for (let elem of selectAll('audio')) {
            let mediaSource = context.createMediaElementSource(elem.elt);
            mediaSource.connect(p5.soundOut);
        }
		audioElement = document.getElementById('mediaPlayerAudio');

        // Load Objects into layout (autoload)
	    initObject();
    } 

    function touchStarted() {
        getAudioContext().resume();
    }

    function draw() {
        // Media Progress Bar
		let musicCurrentTime = audioElement.currentTime;
		let musicDuration = audioElement.duration;
		let musicProgress = (musicCurrentTime/musicDuration) * 100;
		$(".music.progress-bar .bar").css('--music-progress', `${musicProgress}%`);

        // Spectrum Data
        let spectrum = fft.analyze();
        let waveform = fft.waveform();

	    // Spectrume Energy
		let bassEnergy = fft.getEnergy("bass"); let bass_e = (bassEnergy/512) * 1; 
		let lowMidEnergy = fft.getEnergy("lowMid"); let gitar_e = (lowMidEnergy/512) * 0.8; 
		let midEnergy = fft.getEnergy("mid"); let snare_e = (midEnergy/512) * 0.2;
        let energyCombine = (bass_e + gitar_e + snare_e );
        let energyStrength = ( Math.pow((energyCombine), 5) * energyCombine ) * 3;

        let flowData = {energy: energyStrength, spectrum: spectrum}

        // Read object and update into layout
        for (let key in objectMemory) {
            if (objectMemory.hasOwnProperty(key)) {
                let item = objectMemory[key];
                switch (item.tipe) {
                    case 100:
                        mainLayoutUpdate(item, flowData);
                        break;
                    case 2:
                        objImageUpdate(item, flowData);
                        break;
                    case 1:
                        objSpectrumUpdate(item, flowData);
                        break;
                }
            }
        }

        // Debugging
		if (count_delay > 60){
			// Do something :v
			count_delay = 0;
		}else{
			count_delay ++;
		}
    }
</script>
<script>
   
	$(document).ready(function() {

        // Tombol Aksi Load Object
        $(document).on("click", ".action-designer-object-reset", function(e) {
            let objId = $(this).attr('designer-object-id');

            if (objId){
                console.log(objectMemoryDefault);
                // Reset ke default
                objectMemory[objId] = JSON.parse(JSON.stringify(objectMemoryDefault[objId]));
            }else{
                // Reset ke pabrik
                objectMemory = JSON.parse(JSON.stringify(objectMemoryDefault));
            }
            
            // Reload Object
            initObject();
        });

        // Tombol Aksi Load Object
        $(document).on("click", ".action-designer-object-save", async function(e) {
            // Simpan Object
            saveObject();

            // Load profile as variable json
            let json = await loadObject();
            rememberObject = ( JSON.stringify(json) );

            saveJsonToFile(rememberObject, 'spectrum-profile');
        });
            
        // Tombol Aksi Load Object
        $(document).on("change", ".action-designer-object-load", async function(e) {
            const files = event.target.files; 
            
            const file = files[0];
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const jsonObject = JSON.parse( (e.target.result) );
                    objectMemory = jsonObject;

                    // Reload Object
                    initObject();
                } catch (error) {
                    console.error('Invalid JSON file');
                }
            };
            reader.readAsText(file);
        });

        // Tombol Aksi Load Object
        $(document).on("change", ".action-designer-object-file", async function(e) {
            let objId = $(this).attr('designer-object-id');
            let objParam = $(this).attr('designer-object-param');
            
            const files = event.target.files[0];
            let tempFileBuffer = await file2Base64(files);
            objectMemory[objId]['params'][objParam] = tempFileBuffer;

            // Reload Object
            initObject();
        });

        $(document).on("change", ".action-designer-object-config", function(e) {
            // Read object config 
            let objId = $(this).attr('designer-object-id');
            let objParam = $(this).attr('designer-object-param');
            let objParamValue = $(this).val();

            // Set object config
            objectMemory[objId]['params'][objParam] = objParamValue;
            
            // Reload Object
            initObject();
        });

        // Tombol Aksi Play/Pause
        $(document).on("click", ".action-mediaplayer", function(e) {
            $('#mediaPlayerAudio').prop("paused") ? $("#mediaPlayerAudio")[0].play() : $("#mediaPlayerAudio")[0].pause();
        });

        // Cek setiap saat untuk perubahaan sesuai kondisi
        setInterval(() => {
            // Perubahan tombol action-mediaplayer disebabkan mediaPlayerAudio
            if ($('#mediaPlayerAudio').prop("paused") == true){
                $(".action-mediaplayer").html('<i class="bi bi-play-fill"></i>');
            }else{
                $(".action-mediaplayer").html('<i class="bi bi-pause-fill"></i>');
            }
        }, 1000);
        
    });
    
</script>
</html>
